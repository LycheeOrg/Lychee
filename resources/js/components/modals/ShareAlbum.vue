<template>
	<Dialog v-model:visible="visible" modal>
		<template #container="{ closeCallback }">
			<div class="flex flex-wrap p-9 gap-5 justify-center align-top text-muted-color" v-if="!qrCodeOpen">
				<MiniIcon class="w-10 h-10 ionicons cursor-pointer" icon="twitter" v-on:click="openTwitter" />
				<MiniIcon class="w-10 h-10 ionicons cursor-pointer" icon="facebook" v-on:click="openFacebook" />
				<MiniIcon class="w-10 h-10 cursor-pointer" icon="envelope-closed" v-on:click="openMailto" />
				<a class="cursor-pointer" v-on:click="copyToClipboard()">
					<MiniIcon class="w-10 h-10" icon="link-intact" />
				</a>
				<MiniIcon class="w-10 h-10" icon="grid-two-up" v-on:click="openQrCode" />
			</div>
			<div class="flex flex-wrap p-9 gap-5 justify-center align-top text-muted-color" v-if="qrCodeOpen">
				<canvas id="canvas"></canvas>
			</div>
			<Button
				@click="
					qrCodeOpen = false;
					closeCallback();
				"
				:label="trans('lychee.CLOSE')"
				class="rounded-none font-bold py-2 w-full ease-in-out select-none hover:text-danger-700 border-t border-t-black/20 hover:bg-white/[.02]"
				>{{ trans("lychee.CLOSE") }}</Button
			>
		</template>
	</Dialog>
</template>
<script setup lang="ts">
import { ref, watch } from "vue";
import Button from "primevue/button";
import Dialog from "primevue/dialog";
import { useToast } from "primevue/usetoast";
import QRCode from "qrcode";
import { trans } from "laravel-vue-i18n";
import MiniIcon from "@/components/icons/MiniIcon.vue";

const props = defineProps<{
	url: string;
	title: string;
}>();
const toast = useToast();

const qrCodeOpen = ref(false);

const visible = ref(false);
const url = ref(props.url);
const title = ref(props.title);

function copyToClipboard() {
	navigator.clipboard
		.writeText(url.value)
		.then(() => toast.add({ severity: "info", summary: "Info", detail: trans("lychee.URL_COPIED_TO_CLIPBOARD"), life: 3000 }));
}

function openQrCode() {
	qrCodeOpen.value = true;
	QRCode.toCanvas(
		document.getElementById("canvas"),
		url.value,
		{
			errorCorrectionLevel: "H",
			// fill: '#000000',
			// background: '#FFFFFF',
			// size: 300,
		},
		function (err: Error | null | undefined) {
			if (err) throw err;
		},
	);
}

function openTwitter() {
	window.open(`https://twitter.com/share?url=${encodeURIComponent(url.value)}`);
}
function openFacebook() {
	window.open(`https://www.facebook.com/sharer.php?u=${encodeURIComponent(url.value)}?t=${encodeURIComponent(title.value)}`);
}
function openMailto() {
	window.open(`mailto:?subject=${encodeURIComponent(title.value)}&body=${encodeURIComponent(url.value)}`);
}

defineExpose({
	toggleModal: () => {
		visible.value = !visible.value;
	},
});

watch(
	() => [props.url, props.title],
	([newUrl, newTitle], [_oldUrl, _oldTitle]) => {
		url.value = newUrl;
		title.value = newTitle;
	},
);
</script>
